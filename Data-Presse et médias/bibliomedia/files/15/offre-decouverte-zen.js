define(function(require){"use strict";var e,$=require("jquery"),t=require("lmd/core/storage"),o=require("lmd/ui/lecture-zen"),n=require("lmd/ui/lightbox"),r=(require("lmd/core/service"),require("lmd/core/auth")),c=require("hoganpower!/partials/layout/tracking/decouverte_zen_register.html.mu@www"),i=(new Date).getTime(),a="https://checkout.lemonde.fr/gcheckout/cart/add/sku/S_DEC30J0OJDPRLVT1FPRIO/",u="EREC-265-[LECTURE_ZEN]",d="EREC-265-[3PV]",l=null,f="Inscription_offre_decouverte::Lemondefr::",_={med:function(e){xt_med("F","19",f+e)},form:function(e,t){xt_form(e,"C","19",f+t,"A",!1)}},s={overlay:".fond_overlay.offre_decouverte",wrapper:".overlay.offre_decouverte",button:".js_fermer_offre_decouverte",top:85,overlayClose:!1,overlaySpeedIn:250,overlaySpeedout:250},m={},h=function(){var e=this;document.location.hostname.search(/www(.*).lemonde./)!==-1&&"/"!==document.location.pathname&&(lmd.conf.decouverte_no_count.indexOf(document.location.pathname)>=0||document.location.pathname!==lmd.conf.url_teaser_ex_decouverte&&("undefined"!=typeof window.screen&&"undefined"!=typeof window.screen.width&&window.screen.width<699||r.loadUser().done(function(){r.authenticated&&r.user.abonne||e.init()})))};return h.prototype={init:function(){var e=this,n=t.get("lmd_decouverte_cpt")||{page_count:0,already_shown:!1,url:""},r=12096e5;t.get("lmd_decouverte")||{};if(n.url!==document.location.href&&!n.already_shown){var c=!1,i=!!lmd.context.item&&void 0!==lmd.context.item.type&&void 0!==lmd.context.item.type.nom&&"article"===lmd.context.item.type.nom;n.url=document.location.href,n.page_count++,c=n.page_count>=parseInt(lmd.conf.limit_wall),c&&i&&(n.already_shown=!0,e.operation_id=lmd.conf.offre_decouverte_avec_abo_auto,e.afficherLectureZen(),l=d),t.set("lmd_decouverte_cpt",n,r)}o.getInstance().bouton&&o.getInstance().bouton.addClass("btn_offre_decouverte_zen").on("click",function(){e.boutonLectureZenXiti(),e.operation_id=lmd.conf.offre_decouverte_zen_avec_abo_auto,e.afficherLectureZen(),l=u})},afficherLectureZen:function(){var e=this;o.getInstance().open(function(){o.getInstance().lightbox.instance.disableClosing=!0;var t=0,n=setInterval(function(){t+=1e3,t>=lmd.conf.decouverte_zen_delay&&(e.afficherFormulaire(),clearInterval(n))},1e3)})},afficherFormulaire:function(e,t,i){var a=this,u=i||c;this.lightbox=new n(s),this.lightbox.setLoader(!0),this.lightbox.on("open",function(){o.getInstance().lightbox&&(o.getInstance().lightbox.instance.disableClosing=!1),a.setupFormulaire(),a.loadXiti(),$("#decouverte #no_thanks").click(function(){a.lightbox.close()})}),this.lightbox.on("close",function(){r.authenticated&&r.user.abonne||!o.getInstance().lightbox?o.getInstance().loadXiti():o.getInstance().lightbox.close()}),m=a.getDiscoveryParams(),this.lightbox.open(u.render({conf:lmd.conf,operation_id:e||a.operation_id,popin_class:t||m.popinClass}))},setupFormulaire:function(){var e=this;$("#decouverte").on("submit",function(t){t.preventDefault(),e.hitXiti(),e.poserParticipation(!0),window.location.href=a+"#xtor="+l})},loadXiti:function(){var e=this;switch(e.operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:_.med("Affichage_formulaire");break;case lmd.conf.offre_decouverte_zen_avec_abo_auto:_.med("Affichage_formulaire_bouton_lecture_zen")}var t=document.createElement("img");t.src=lmd.conf.subscription.buttonViewCountUrl+l,t.width=1,t.height=1,document.body.appendChild(t)},hitXiti:function(){var e=this,t=document.getElementById("decouverte");switch(e.operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:_.form(t,"Validation_formulaire");break;case lmd.conf.offre_decouverte_zen_avec_abo_auto:return _.form(t,"Validation_formulaire_bouton_lecture_zen")}},boutonLectureZenXiti:function(){xt_click(o.getInstance().bouton.get(0),"C","19","Offre_decouverte::Lemonde.fr::Bouton_lecture_zen","A")},poserParticipation:function(e){var o=5184e6,n=i+2592e6,r={is_abo:!0,participation:i,date_abo:null,date_fin:n};e&&(r.date_abo=i),t.set("lmd_decouverte",r,o,!1)},getDiscoveryParams:function(){var e=this,t=JSON.parse(lmd.conf.decouverte_cb);switch(e.operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:return t.pages;case lmd.conf.offre_decouverte_zen_avec_abo_auto:return t.zen}}},e=new h,{getInstance:function(){return e}}});